{"version":3,"sources":["../src/core.ts","../src/ui.ts","../src/index.ts"],"names":["ConfigManager","userConfig","env","envConfig","newConfig","OAuthUrlBuilder","config","authData","state","nonce","codeVerifier","codeChallenge","CryptoUtils","base","params","TokenValidator","urlBuilder","idToken","header","payload","decodedHeader","decodedPayload","now","savedNonce","SessionManager","publicKey","key","accessToken","response","data","token","jwk","signature","signatureData","e","PopupManager","url","onClose","left","top","ErrorHandler","error","description","errorMessage","errorMessages","UIComponent","container","tag","className","innerHTML","element","events","event","handler","listeners","EnvironmentSelector","onEnvironmentChange","currentEnv","envOptions","radio","LoginButton","onLogin","isLoading","LoadingSpinner","spinner","style","ErrorDisplay","message","UIManager","title","helpText","cb","environment","newState","c","BackendClient","popupManager","uiManager","code","errorData","statusUrl","statusData","startUrl","userUrl","logoutUrl","BjPassAuthWidget","origin","allowed","authUrl","queryParams","savedState","tokenData","errorCode","userData","cfgRaw","index_default"],"mappings":"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","file":"index.js","sourcesContent":["\nimport { AuthConfig, JWKSResponse, BackendAuthResponse, TokenResponse } from \"./types\";\nimport { CryptoUtils, SessionManager } from \"./utils\";\n\nexport class ConfigManager {\n  private environments = {\n    test: {\n      baseUrl: \"https://test-tx-pki.gouv.bj\",\n      defaultAuthServer: \"main-as\",\n    },\n    production: {\n      baseUrl: \"https://tx-pki.gouv.bj\",\n      defaultAuthServer: \"main-as\",\n    },\n  } as const;\n\n  private defaultConfig: AuthConfig = {\n    environment: \"test\",\n    clientId: \"\",\n    authServer: \"\",\n    scope: \"openid profile\",\n    redirectUri: \"http://127.0.0.1:5500/examples/redirect.html\",\n    pkce: true,\n    verifyAccessToken: false,\n    tokenVerificationScopes: [\"urn:safelayer:eidas:oauth:token:introspect\"],\n    beUrl: \"\",\n    beBearer: \"\",\n    header: {},\n    ui: {\n      showEnvSelector: true,\n      container: \"#bjpass-auth-container\",\n      language: \"fr\",\n      primaryColor: \"#0066cc\",\n      theme: \"default\",\n    },\n    backendUrl: \"https://your-backend.com\",\n    backendEndpoints: {\n      start: \"/auth/start\",\n      status: \"/auth/api/status\",\n      user: \"/auth/api/user\",\n      logout: \"/auth/api/logout\",\n      refresh: \"/auth/api/refresh\",\n    },\n    frontendOrigin: \"https://your-frontend.com\",\n    backendOrigin: \"https://your-backend.com\",\n    useBackend: true,\n    popupMode: true,\n    autoClosePopup: true,\n  };\n\n  private config: AuthConfig;\n  private resolvedConfig: AuthConfig & { baseUrl: string };\n\n  constructor(userConfig: Partial<AuthConfig> = {}) {\n    this.config = { ...this.defaultConfig, ...userConfig };\n    this.resolvedConfig = this.applyEnvironmentConfig();\n  }\n\n  private applyEnvironmentConfig() {\n    const env = this.config.environment || \"test\";\n    const envConfig = this.environments[env as keyof typeof this.environments] || this.environments.test;\n    return {\n      ...this.config,\n      baseUrl: envConfig.baseUrl,\n      authServer: this.config.authServer || envConfig.defaultAuthServer,\n    };\n  }\n\n  updateConfig(newConfig: Partial<AuthConfig>) {\n    this.config = { ...this.config, ...newConfig };\n    this.resolvedConfig = this.applyEnvironmentConfig();\n  }\n\n  get(): AuthConfig & { baseUrl: string } {\n    return this.resolvedConfig;\n  }\n\n  getEnvironments(): string[] {\n    return Object.keys(this.environments);\n  }\n}\n\nexport class OAuthUrlBuilder {\n  constructor(private config: AuthConfig & { baseUrl: string }) {}\n  async buildAuthorizationUrl(authData: { state: string; nonce?: string; codeVerifier: string }): Promise<string> {\n    const { state, nonce, codeVerifier } = authData;\n    const codeChallenge = await CryptoUtils.generateCodeChallenge(codeVerifier);\n    const base = new URL(`${this.config.baseUrl}/trustedx-authserver/oauth`);\n    if (this.config.authServer) {\n      base.pathname += `/${encodeURIComponent(this.config.authServer)}`;\n    }\n    const params = new URLSearchParams({\n      response_type: \"code\",\n      client_id: this.config.clientId,\n      redirect_uri: this.config.redirectUri,\n      scope: this.config.scope.split(\"+\").join(\" \"),\n      state,\n      code_challenge: codeChallenge,\n      code_challenge_method: \"S256\",\n      prompt: \"login\",\n    });\n    if (this.config.scope.includes(\"openid\") && nonce) params.set(\"nonce\", nonce);\n    base.search = params.toString();\n    return base.toString();\n  }\n  buildTokenUrl(): string {\n    return `${this.config.baseUrl}/trustedx-authserver/oauth/${encodeURIComponent(this.config.authServer)}/token`;\n  }\n  buildJWKSUrl(): string {\n    return `${this.config.baseUrl}/trustedx-authserver/oauth/keys`;\n  }\n  buildIntrospectionUrl(): string {\n    return `${this.config.baseUrl}/trustedx-authserver/oauth/token/verify`;\n  }\n}\n\nexport class TokenValidator {\n  constructor(private config: AuthConfig, private urlBuilder: OAuthUrlBuilder) {}\n  async validateIdToken(idToken: string): Promise<unknown> {\n    const [header, payload] = idToken.split(\".\");\n    if (!header || !payload) {\n      throw new Error(\"Invalid idToken format\");\n    }\n    const decodedHeader = JSON.parse(atob(header));\n    const decodedPayload = JSON.parse(atob(payload));\n    const now = Math.floor(Date.now() / 1000);\n    const savedNonce = SessionManager.getItem(\"nonce\");\n    if (decodedPayload.exp < now) throw new Error(\"Token expired\");\n    if (decodedPayload.nonce !== savedNonce) throw new Error(\"Invalid nonce\");\n    if (decodedPayload.aud !== this.config.clientId) throw new Error(\"Invalid audience\");\n    const jwks = await this.fetchJWKS();\n    const publicKey = jwks.keys.find((key) => key.kid === decodedHeader.kid);\n    if (!publicKey) throw new Error(\"No matching public key found\");\n    const isValid = await this.verifySignature(idToken, publicKey);\n    if (!isValid) throw new Error(\"Invalid signature\");\n    return decodedPayload;\n  }\n  async verifyAccessToken(accessToken: string): Promise<unknown> {\n    const response = await fetch(this.urlBuilder.buildIntrospectionUrl(), {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n        \"Authorization\": `Bearer ${accessToken}`\n      },\n      body: new URLSearchParams({ token: accessToken } as any)\n    });\n    const data = await response.json();\n    if (!response.ok || !data.active) {\n      throw new Error(\"Token verification failed\");\n    }\n    return data;\n  }\n  private async fetchJWKS(): Promise<JWKSResponse> {\n    const response = await fetch(this.urlBuilder.buildJWKSUrl());\n    if (!response.ok) throw new Error(\"Failed to fetch JWKS\");\n    return await response.json();\n  }\n  private async verifySignature(token: string, jwk: any): Promise<boolean> {\n    try {\n      const key = await crypto.subtle.importKey(\n        \"jwk\",\n        jwk,\n        { name: \"RSASSA-PKCS1-v1_5\", hash: { name: \"SHA-256\" } },\n        false,\n        [\"verify\"]\n      );\n      const [header, payload, signature] = token.split(\".\");\n      if (!signature) {\n        throw new Error(\"Token signature is missing\");\n      }\n      const signatureData = (await import(\"./utils\")).CryptoUtils.base64UrlToArrayBuffer(signature);\n      const data = new TextEncoder().encode(`${header}.${payload}`);\n      return await crypto.subtle.verify(\"RSASSA-PKCS1-v1_5\", key, signatureData, data);\n    } catch (e) {\n      console.error(\"Signature verification error:\", e);\n      return false;\n    }\n  }\n}\n\nexport class PopupManager {\n  private popup: Window | null = null;\n  private checkInterval: number | null = null;\n  open(url: string, onClose?: () => void) {\n    const width = 500, height = 600;\n    const left = (screen.width - width) / 2;\n    const top = (screen.height - height) / 2;\n    this.popup = window.open(\n      url,\n      \"BjPassAuth\",\n      `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes`\n    );\n    this.checkInterval = window.setInterval(() => {\n      if (this.popup && this.popup.closed) {\n        this.close();\n        onClose?.();\n      }\n    }, 500);\n  }\n  close() {\n    if (this.checkInterval) {\n      clearInterval(this.checkInterval);\n      this.checkInterval = null;\n    }\n    if (this.popup && !this.popup.closed) this.popup.close();\n    this.popup = null;\n  }\n  isOpen() {\n    return !!(this.popup && !this.popup.closed);\n  }\n}\n\nexport class ErrorHandler {\n  static getErrorMessage(error: string, description?: string): string {\n    let errorMessage = \"Erreur d'authentification\";\n    const errorMessages: Record<string, string> = {\n      invalid_token: \"Token invalide ou expiré\",\n      unsuported_grant_type_error: \"Type de subvention OAuth invalide\",\n      insufficient_scope: \"Permissions insuffisantes\",\n      invalid_grant: \"Code d'autorisation invalide ou expiré\",\n      access_denied: \"Authentification annulée\",\n      invalid_request: \"Requête invalide\",\n      invalid_scope: \"Permissions invalides\",\n      server_error: \"Erreur du serveur\",\n      popup_closed: \"La fenêtre d'authentification a été fermée\",\n      browser_error: \"Navigateur non supporté\",\n      backend_error: \"Erreur du backend\",\n      token_error: \"Erreur de validation du token\",\n      token_exchange_error: \"Erreur lors de l'échange\",\n    };\n    if (errorMessages[error]) errorMessage = errorMessages[error];\n    if (description) errorMessage += `: ${description}`;\n    return errorMessage;\n  }\n}\n","\nimport type { AuthConfig } from \"./types\";\n\nclass UIComponent {\n  protected container: HTMLElement;\n  protected element: HTMLElement | null = null;\n  private eventListeners = new Map<HTMLElement, { event: string; handler: EventListener }[]>();\n\n  constructor(container: HTMLElement) {\n    this.container = container;\n  }\n  protected createElement<T extends keyof HTMLElementTagNameMap>(tag: T, className = \"\", innerHTML = \"\") {\n    const element = document.createElement(tag);\n    if (className) element.className = className;\n    if (innerHTML) element.innerHTML = innerHTML;\n    return element as HTMLElementTagNameMap[T];\n  }\n  protected addEventListeners(element: HTMLElement, events: Record<string, EventListener>) {\n    Object.entries(events).forEach(([event, handler]) => {\n      element.addEventListener(event, handler);\n      if (!this.eventListeners.has(element)) this.eventListeners.set(element, []);\n      this.eventListeners.get(element)!.push({ event, handler });\n    });\n  }\n  removeEventListeners() {\n    this.eventListeners.forEach((listeners, element) => {\n      listeners.forEach(({ event, handler }) => element.removeEventListener(event, handler));\n    });\n    this.eventListeners.clear();\n  }\n  destroy() {\n    this.removeEventListeners();\n    if (this.element?.parentNode) this.element.parentNode.removeChild(this.element);\n  }\n  render(): void { throw new Error(\"render() must be implemented by subclass\"); }\n  show() { if (this.element) this.element.style.display = \"block\"; }\n  hide() { if (this.element) this.element.style.display = \"none\"; }\n}\n\nexport class EnvironmentSelector extends UIComponent {\n  constructor(container: HTMLElement, private config: { get(): AuthConfig & { baseUrl: string }; getEnvironments(): string[] }, private onEnvironmentChange: (env: string) => void) {\n    super(container);\n    this.render();\n  }\n  render() {\n    if (!this.config.get().ui.showEnvSelector) return;\n    const currentEnv = this.config.get().environment;\n    const envOptions = this.config.getEnvironments().map(env => `\n      <label>\n        <input type=\"radio\" name=\"env\" value=\"${env}\" ${env === currentEnv ? \"checked\" : \"\"}>\n        ${env.charAt(0).toUpperCase() + env.slice(1)}\n      </label>\n    `).join(\"\");\n    this.element = this.createElement(\"div\", \"bjpass-env-selector\", `\n      <div class=\"env-selector-label\">Environment:</div>\n      ${envOptions}\n    `);\n    this.element.querySelectorAll('input[name=\"env\"]').forEach((radio) => {\n      this.addEventListeners(radio as HTMLInputElement, { change: (e: Event) => this.onEnvironmentChange((e.target as HTMLInputElement).value) });\n    });\n    this.container.appendChild(this.element);\n  }\n}\n\nexport class LoginButton extends UIComponent {\n  constructor(container: HTMLElement, private config: AuthConfig, private onLogin: () => void) {\n    super(container);\n    this.render();\n  }\n  render() {\n    this.element = this.createElement(\"button\", \"bjpass-login-btn\", \"Se connecter\");\n    (this.element as HTMLButtonElement).type = \"button\";\n    this.element.style.cssText = `\n      width: 100%;\n      padding: 12px 24px;\n      background-color: ${this.config.ui.primaryColor};\n      color: white;\n      border: none;\n      border-radius: 6px;\n      font-size: 16px;\n      cursor: pointer;\n      transition: background-color 0.2s;\n    `;\n    this.addEventListeners(this.element, {\n      click: () => this.onLogin(),\n      mouseover: () => { if (this.element) this.element.style.opacity = \"0.9\"; },\n      mouseout: () => { if (this.element) this.element.style.opacity = \"1\"; }\n    });\n    this.container.appendChild(this.element);\n  }\n  setLoading(isLoading: boolean) {\n    if (!this.element) return;\n    (this.element as HTMLButtonElement).disabled = isLoading;\n    this.element.innerHTML = isLoading ? \"Connexion...\" : \"Se connecter\";\n  }\n}\n\nexport class LoadingSpinner extends UIComponent {\n  constructor(container: HTMLElement) { super(container); this.render(); }\n  render() {\n    this.element = this.createElement(\"div\", \"bjpass-loading\", `\n      <div class=\"spinner\"></div>\n      <div class=\"loading-text\">Authentification en cours...</div>\n    `);\n    this.element.style.cssText = \"display:none;text-align:center;padding:20px;\";\n    const spinner = this.element.querySelector(\".spinner\") as HTMLElement;\n    spinner.style.cssText = \"border:3px solid #f3f3f3;border-radius:50%;border-top:3px solid #0066cc;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 10px;\";\n    if (!document.getElementById(\"bjpass-spinner-styles\")) {\n      const style = document.createElement(\"style\");\n      style.id = \"bjpass-spinner-styles\";\n      style.textContent = \"@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}\";\n      document.head.appendChild(style);\n    }\n    this.container.appendChild(this.element);\n  }\n}\n\nexport class ErrorDisplay extends UIComponent {\n  constructor(container: HTMLElement) { super(container); this.render(); }\n  render() {\n    this.element = this.createElement(\"div\", \"bjpass-error\");\n    this.element.style.cssText = \"display:none;padding:12px;margin:10px 0;background-color:#fee;border:1px solid #fcc;border-radius:4px;color:#c33;font-size:14px;\";\n    this.container.appendChild(this.element);\n  }\n  showError(message: string) { if (!this.element) return; this.element.textContent = message; this.show(); }\n  clearError() { if (!this.element) return; this.element.textContent = \"\"; this.hide(); }\n}\n\nexport class UIManager {\n  private container: HTMLElement | null = null;\n  private components: any = {};\n  private state = { isLoading: false, error: null as string | null };\n  private mainElement!: HTMLElement;\n  constructor(private config: AuthConfig & { baseUrl: string }) {}\n  initialize() {\n    this.container = document.querySelector(this.config.ui.container);\n    if (!this.container) throw new Error(`Container ${this.config.ui.container} not found`);\n    this.createMainContainer();\n    this.initializeComponents();\n  }\n  private createMainContainer() {\n    this.mainElement = document.createElement(\"div\");\n    this.mainElement.className = \"bjpass-widget\";\n    this.mainElement.style.cssText = \"max-width:400px;margin:0 auto;padding:20px;border:1px solid #ddd;border-radius:8px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;\";\n    const title = document.createElement(\"h3\");\n    title.textContent = \"Authentification BjPass\";\n    title.style.cssText = `color:${this.config.ui.primaryColor};text-align:center;margin:0 0 20px;`;\n    this.mainElement.appendChild(title);\n    this.container!.appendChild(this.mainElement);\n  }\n  private initializeComponents() {\n    this.components.envSelector = new EnvironmentSelector(this.mainElement, { get: () => this.config, getEnvironments: () => [\"test\",\"production\"] }, this.onEnvironmentChange.bind(this));\n    this.components.loginButton = new LoginButton(this.mainElement, this.config, this.onLoginClick.bind(this));\n    this.components.loadingSpinner = new LoadingSpinner(this.mainElement);\n    this.components.errorDisplay = new ErrorDisplay(this.mainElement);\n    const helpText = document.createElement(\"p\");\n    helpText.textContent = \"Vous serez redirigé vers le service d'authentification sécurisée\";\n    helpText.style.cssText = \"text-align:center;margin:15px 0 0;font-size:.9em;color:#666;\";\n    this.mainElement.appendChild(helpText);\n  }\n  setOnEnvironmentChange(cb: (env: string) => void) { (this as any).onEnvironmentChangeCallback = cb; }\n  setOnLogin(cb: () => void) { (this as any).onLoginCallback = cb; }\n  private onEnvironmentChange(environment: string) { (this as any).onEnvironmentChangeCallback?.(environment); }\n  private onLoginClick() { (this as any).onLoginCallback?.(); }\n  setState(newState: Partial<{ isLoading: boolean; error: string | null }>) {\n    this.state = { ...this.state, ...newState };\n    this.updateUI();\n  }\n  private updateUI() {\n    if (this.state.isLoading) {\n      this.components.loginButton.setLoading(true);\n      this.components.loadingSpinner.show();\n      this.components.errorDisplay.clearError();\n    } else {\n      this.components.loginButton.setLoading(false);\n      this.components.loadingSpinner.hide();\n      if (this.state.error) this.components.errorDisplay.showError(this.state.error);\n      else this.components.errorDisplay.clearError();\n    }\n  }\n  destroy() {\n    Object.values(this.components).forEach((c: any) => c?.destroy?.());\n    if (this.mainElement?.parentNode) this.mainElement.parentNode.removeChild(this.mainElement);\n  }\n}\nexport { UIComponent };\n","\nimport type { AuthConfig, BackendAuthResponse, TokenResponse } from \"./types\";\nimport { ConfigManager, OAuthUrlBuilder, TokenValidator, PopupManager, ErrorHandler } from \"./core\";\nimport { UIManager } from \"./ui\";\nimport { SessionManager } from \"./utils\";\n\nexport class BackendClient {\n  constructor(private config: AuthConfig & { baseUrl: string }, private popupManager: PopupManager, private uiManager: UIManager) {}\n\n  async exchangeCode(code: string, state: string) {\n    const response = await fetch(this.config.beUrl, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\", ...this.config.header },\n      body: JSON.stringify({\n        code,\n        state,\n        redirect_uri: this.config.redirectUri,\n        code_verifier: SessionManager.getItem(\"code_verifier\"),\n      }),\n    });\n    if (!response.ok) {\n      let errorData: any = {};\n      try { errorData = await response.json(); } catch {}\n      throw new Error(errorData.message || \"Échec de l'authentification\");\n    }\n    return await response.json();\n  }\n\n  async exchangeCodeDirect(code: string, state: string, urlBuilder: OAuthUrlBuilder) {\n    const codeVerifier = SessionManager.getItem(\"code_verifier\");\n    if (!codeVerifier) throw new Error(\"Missing code verifier\");\n    const response = await fetch(urlBuilder.buildTokenUrl(), {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n      body: new URLSearchParams({\n        grant_type: \"authorization_code\",\n        code,\n        redirect_uri: this.config.redirectUri,\n        client_id: this.config.clientId,\n        code_verifier: codeVerifier,\n      } as any),\n    });\n    const data = await response.json();\n    if (!response.ok) throw new Error(data.error_description || \"Failed to obtain token\");\n    return data as TokenResponse;\n  }\n\n  async handleBackendAuthResponse(data: BackendAuthResponse) {\n    if ((data as any).status === \"success\") {\n      await this.handleBackendAuthSuccess(data as any);\n    } else {\n      this.handleBackendAuthError(data as any);\n    }\n  }\n\n  private async handleBackendAuthSuccess(data: any) {\n    SessionManager.setItem(\"user\", JSON.stringify(data.user));\n    SessionManager.setItem(\"success\", \"true\");\n    this.popupManager.close();\n    this.uiManager.setState({ isLoading: false, error: null });\n    this.config.onSuccess?.({ user: data.user, backendData: data, source: \"backend\" });\n    await this.verifyBackendStatus();\n  }\n\n  private handleBackendAuthError(data: any) {\n    this.popupManager.close();\n    const message = data.message || \"Erreur d'authentification\";\n    const error = data.error || \"backend_error\";\n    this.uiManager.setState({ isLoading: false, error: ErrorHandler.getErrorMessage(error, message) });\n    this.config.onError?.({ error, error_description: message });\n  }\n\n  async verifyBackendStatus() {\n    const statusUrl = new URL(this.config.backendEndpoints.status, this.config.backendUrl);\n    const response = await fetch(statusUrl.toString(), {\n      method: \"GET\",\n      credentials: \"include\",\n      headers: { Accept: \"application/json\", \"Content-Type\": \"application/json\" },\n    });\n    if (!response.ok) throw new Error(`Status check failed: ${response.status}`);\n    const statusData = await response.json();\n    if (statusData.authenticated) {\n      SessionManager.setItem(\"user\", JSON.stringify(statusData.user));\n      SessionManager.setItem(\"authenticated\", \"true\");\n    } else {\n      SessionManager.clear();\n      throw new Error(\"User not authenticated on backend\");\n    }\n  }\n\n  async startBackendAuthFlow() {\n    if (!this.config.backendUrl) throw new Error(\"Backend URL not configured\");\n    const startUrl = new URL(this.config.backendEndpoints.start, this.config.backendUrl);\n    if (this.config.returnUrl) startUrl.searchParams.set(\"return_url\", this.config.returnUrl);\n    this.popupManager.open(startUrl.toString(), () => {\n      this.uiManager.setState({ isLoading: false });\n      if (!SessionManager.getItem(\"success\")) {\n        this.config.onError?.({ error: \"popup_closed\", error_description: \"La fenêtre d'authentification a été fermée\" });\n      }\n    });\n  }\n\n  async getUserInfoFromBackend() {\n    const userUrl = new URL(this.config.backendEndpoints.user, this.config.backendUrl);\n    const response = await fetch(userUrl.toString(), {\n      method: \"GET\",\n      credentials: \"include\",\n      headers: { Accept: \"application/json\", \"Content-Type\": \"application/json\" },\n    });\n    if (!response.ok) throw new Error(`User info request failed: ${response.status}`);\n    const userData = await response.json();\n    return userData.user;\n  }\n\n  async logoutFromBackend() {\n    const logoutUrl = new URL(this.config.backendEndpoints.logout, this.config.backendUrl);\n    const response = await fetch(logoutUrl.toString(), {\n      method: \"POST\",\n      credentials: \"include\",\n      headers: { Accept: \"application/json\", \"Content-Type\": \"application/json\" },\n    });\n    if (!response.ok) throw new Error(`Backend logout failed: ${response.status}`);\n  }\n}\n\nexport class BjPassAuthWidget {\n  private configManager: ConfigManager;\n  private uiManager: UIManager;\n  private urlBuilder: OAuthUrlBuilder;\n  private tokenValidator: TokenValidator;\n  private backendClient: BackendClient;\n  private popupManager: PopupManager;\n\n  constructor(config: Partial<AuthConfig> = {}) {\n    this.configManager = new ConfigManager(config);\n    this.uiManager = new UIManager(this.configManager.get());\n    this.urlBuilder = new OAuthUrlBuilder(this.configManager.get());\n    this.tokenValidator = new TokenValidator(this.configManager.get(), this.urlBuilder);\n    this.popupManager = new PopupManager();\n    this.backendClient = new BackendClient(this.configManager.get(), this.popupManager, this.uiManager);\n    if (!(\"crypto\" in globalThis) || !(\"subtle\" in crypto)) {\n      throw new Error(\"Browser not supported. Please use a modern browser.\");\n    }\n    this.initialize();\n    this.setupMessageListener();\n  }\n\n  private initialize() {\n    this.uiManager.initialize();\n    this.setupEventHandlers();\n  }\n\n  private setupEventHandlers() {\n    (this.uiManager as any).setOnEnvironmentChange((environment: string) => {\n      this.configManager.updateConfig({ environment } as any);\n      this.urlBuilder = new OAuthUrlBuilder(this.configManager.get());\n      this.tokenValidator = new TokenValidator(this.configManager.get(), this.urlBuilder);\n      this.backendClient = new BackendClient(this.configManager.get(), this.popupManager, this.uiManager);\n    });\n    (this.uiManager as any).setOnLogin(() => { this.startAuthFlow(); });\n  }\n\n  private setupMessageListener() {\n    window.addEventListener(\"message\", (event: MessageEvent) => {\n      if (!this.isValidMessageOrigin(event.origin)) return;\n      const data = event.data as BackendAuthResponse;\n      if (data && (data as any).type === \"bjpass-auth-response\") {\n        this.backendClient.handleBackendAuthResponse(data);\n      }\n    });\n  }\n\n  private isValidMessageOrigin(origin: string) {\n    const config = this.configManager.get();\n    const allowedOrigins = [config.backendOrigin, config.frontendOrigin];\n    return allowedOrigins.some((allowed) => allowed === \"*\" || allowed === origin);\n  }\n\n  async startAuthFlow() {\n    try {\n      const config = this.configManager.get();\n      this.uiManager.setState({ isLoading: true, error: null });\n      if (config.useBackend) {\n        await this.backendClient.startBackendAuthFlow();\n      } else {\n        await this.startDirectAuthFlow();\n      }\n    } catch (error: any) {\n      this.handleError(\"auth_flow_error\", error?.message);\n    }\n  }\n\n  private async startDirectAuthFlow() {\n    const config = this.configManager.get();\n    const authData = SessionManager.generateAndStoreAuthData(config.scope);\n    const authUrl = await this.urlBuilder.buildAuthorizationUrl(authData as any);\n    this.popupManager.open(authUrl, () => {\n      this.uiManager.setState({ isLoading: false });\n      if (!SessionManager.getItem(\"success\")) {\n        this.handleError(\"popup_closed\", \"La fenêtre d'authentification a été fermée\");\n      }\n    });\n  }\n\n  async handlePopupResponse(queryParams: string) {\n    try {\n      const params = new URLSearchParams(queryParams);\n      const code = params.get(\"code\");\n      const state = params.get(\"state\");\n      const error = params.get(\"error\");\n      if (error) { this.handleError(error, params.get(\"error_description\") || undefined); return; }\n      if (!code || !state) { this.handleError(\"invalid_response\", \"Code ou state manquant\"); return; }\n      const savedState = SessionManager.getItem(\"state\");\n      if (state !== savedState) { this.handleError(\"invalid_state\", \"Paramètre state invalide\"); return; }\n      SessionManager.setItem(\"success\", \"true\");\n      this.popupManager.close();\n      await this.exchangeCodeForTokens(code, state);\n    } catch (error: any) {\n      this.handleError(\"callback_error\", error?.message);\n    }\n  }\n\n  async exchangeCodeForTokens(code: string, state: string) {\n    try {\n      const config = this.configManager.get();\n      let tokenData: any;\n      if (config.beUrl) {\n        tokenData = await this.backendClient.exchangeCode(code, state);\n      } else {\n        this.handleError(\"unsuported_grant_type_error\", \"Type de subvention OAuth non encore pris en charge.\");\n        return;\n      }\n      await this.validateTokens(tokenData.data);\n      SessionManager.clear();\n      this.uiManager.setState({ isLoading: false, error: null });\n      config.onSuccess?.(tokenData);\n    } catch (error: any) {\n      this.handleError(\"token_exchange_error\", error?.message);\n    }\n  }\n\n  private async validateTokens(tokenData: TokenResponse) {\n    const config = this.configManager.get();\n    if (tokenData.id_token && config.scope.includes(\"openid\")) {\n      await this.tokenValidator.validateIdToken(tokenData.id_token);\n    }\n    if (config.verifyAccessToken && tokenData.access_token) {\n      await this.tokenValidator.verifyAccessToken(tokenData.access_token);\n    }\n  }\n\n  private handleError(errorCode: string, description?: string) {\n    const errorMessage = ErrorHandler.getErrorMessage(errorCode, description);\n    this.uiManager.setState({ isLoading: false, error: errorMessage });\n    this.configManager.get().onError?.({ error: errorCode, error_description: description });\n  }\n\n  async getUserInfo() {\n    const config = this.configManager.get();\n    if (config.useBackend) {\n      try {\n        return await new BackendClient(config, this.popupManager, this.uiManager).getUserInfoFromBackend();\n      } catch {\n        // fallback\n      }\n    }\n    const userData = SessionManager.getItem(\"user\");\n    return userData ? JSON.parse(userData) : null;\n  }\n\n  async logout() {\n    const config = this.configManager.get();\n    if (config.useBackend) {\n      try { await new BackendClient(config, this.popupManager, this.uiManager).logoutFromBackend(); } catch {}\n    }\n    SessionManager.clear();\n    this.uiManager.setState({ isLoading: false, error: null });\n    this.configManager.get().onLogout?.();\n  }\n\n  destroy() {\n    this.popupManager.close();\n    this.uiManager.destroy();\n    SessionManager.clear();\n  }\n  refresh() {\n    this.uiManager.destroy();\n    (this as any).initialize?.();\n  }\n  getConfig() { return this.configManager.get(); }\n  updateConfig(newConfig: Partial<AuthConfig>) {\n    this.configManager.updateConfig(newConfig);\n    this.urlBuilder = new OAuthUrlBuilder(this.configManager.get());\n    this.tokenValidator = new TokenValidator(this.configManager.get(), this.urlBuilder);\n  }\n}\n\n// UMD-style globals for <script> usage\ndeclare global {\n  interface Window {\n    BjPassAuthWidget?: typeof BjPassAuthWidget;\n    createBjPassWidget?: (config?: Partial<AuthConfig>) => BjPassAuthWidget;\n  }\n}\nif (typeof window !== \"undefined\") {\n  window.BjPassAuthWidget = BjPassAuthWidget;\n  window.createBjPassWidget = (config: Partial<AuthConfig> = {}) => new BjPassAuthWidget(config);\n  document.addEventListener(\"DOMContentLoaded\", () => {\n    const containers = document.querySelectorAll(\"[data-bjpass-widget]\");\n    containers.forEach((container) => {\n      try {\n        const cfgRaw = (container as HTMLElement).dataset.bjpassWidget || \"{}\";\n        const config = JSON.parse(cfgRaw);\n        (config.ui ||= {}).container = `#${(container as HTMLElement).id}`;\n        new BjPassAuthWidget(config);\n      } catch (e) {\n        console.error(\"Failed to initialize BjPass widget:\", e);\n      }\n    });\n  });\n}\n\nexport default BjPassAuthWidget;\n"]}