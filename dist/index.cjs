'use strict';Object.defineProperty(exports,'__esModule',{value:true});var T=Object.defineProperty;var L=(i,e)=>()=>(i&&(e=i(i=0)),e);var U=(i,e)=>{for(var t in e)T(i,t,{get:e[t],enumerable:true});};var x={};U(x,{CryptoUtils:()=>c,SessionManager:()=>s});var c,s,m=L(()=>{c=class{static generateRandomString(e){let t=new Uint8Array(e);return crypto.getRandomValues(t),Array.from(t,n=>n.toString(16).padStart(2,"0")).join("")}static async generateCodeChallenge(e){let n=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",n);return btoa(String.fromCharCode(...new Uint8Array(r))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}static base64UrlToArrayBuffer(e){let t="=".repeat((4-e.length%4)%4),n=e.replace(/-/g,"+").replace(/_/g,"/")+t,r=atob(n),a=new Uint8Array(r.length);for(let o=0;o<r.length;++o)a[o]=r.charCodeAt(o);return a}static checkBrowserCompatibility(){return !!(globalThis.crypto&&globalThis.crypto.subtle)}},s=class{static setItem(e,t){sessionStorage.setItem(`tx_auth_${e}`,t);}static getItem(e){return sessionStorage.getItem(`tx_auth_${e}`)}static removeItem(e){sessionStorage.removeItem(`tx_auth_${e}`);}static clear(){["state","code_verifier","nonce","success","authenticated","user"].forEach(t=>this.removeItem(t));}static generateAndStoreAuthData(e){let t=c.generateRandomString(32),n=c.generateRandomString(32),r=c.generateRandomString(64);return this.setItem("state",t),this.setItem("code_verifier",r),e.includes("openid")?(this.setItem("nonce",n),{state:t,nonce:n,codeVerifier:r}):{state:t,codeVerifier:r}}};});m();var v=class{constructor(e={}){this.environments={test:{baseUrl:"https://test-tx-pki.gouv.bj",defaultAuthServer:"main-as"},production:{baseUrl:"https://tx-pki.gouv.bj",defaultAuthServer:"main-as"}};this.defaultConfig={environment:"test",clientId:"",authServer:"",scope:"openid profile",redirectUri:"http://127.0.0.1:5500/examples/redirect.html",pkce:true,verifyAccessToken:false,tokenVerificationScopes:["urn:safelayer:eidas:oauth:token:introspect"],beUrl:"",beBearer:"",header:{},ui:{showEnvSelector:true,container:"#bjpass-auth-container",language:"fr",primaryColor:"#0066cc",theme:"default"},backendUrl:"https://your-backend.com",backendEndpoints:{start:"/auth/start",status:"/auth/api/status",user:"/auth/api/user",logout:"/auth/api/logout",refresh:"/auth/api/refresh"},frontendOrigin:"https://your-frontend.com",backendOrigin:"https://your-backend.com",useBackend:true,popupMode:true,autoClosePopup:true};this.config={...this.defaultConfig,...e},this.resolvedConfig=this.applyEnvironmentConfig();}applyEnvironmentConfig(){let e=this.config.environment||"test",t=this.environments[e]||this.environments.test;return {...this.config,baseUrl:t.baseUrl,authServer:this.config.authServer||t.defaultAuthServer}}updateConfig(e){this.config={...this.config,...e},this.resolvedConfig=this.applyEnvironmentConfig();}get(){return this.resolvedConfig}getEnvironments(){return Object.keys(this.environments)}},h=class{constructor(e){this.config=e;}async buildAuthorizationUrl(e){let{state:t,nonce:n,codeVerifier:r}=e,a=await c.generateCodeChallenge(r),o=new URL(`${this.config.baseUrl}/trustedx-authserver/oauth`);this.config.authServer&&(o.pathname+=`/${encodeURIComponent(this.config.authServer)}`);let l=new URLSearchParams({response_type:"code",client_id:this.config.clientId,redirect_uri:this.config.redirectUri,scope:this.config.scope.split("+").join(" "),state:t,code_challenge:a,code_challenge_method:"S256",prompt:"login"});return this.config.scope.includes("openid")&&n&&l.set("nonce",n),o.search=l.toString(),o.toString()}buildTokenUrl(){return `${this.config.baseUrl}/trustedx-authserver/oauth/${encodeURIComponent(this.config.authServer)}/token`}buildJWKSUrl(){return `${this.config.baseUrl}/trustedx-authserver/oauth/keys`}buildIntrospectionUrl(){return `${this.config.baseUrl}/trustedx-authserver/oauth/token/verify`}},d=class{constructor(e,t){this.config=e;this.urlBuilder=t;}async validateIdToken(e){let[t,n]=e.split(".");if(!t||!n)throw new Error("Invalid idToken format");let r=JSON.parse(atob(t)),a=JSON.parse(atob(n)),o=Math.floor(Date.now()/1e3),l=s.getItem("nonce");if(a.exp<o)throw new Error("Token expired");if(a.nonce!==l)throw new Error("Invalid nonce");if(a.aud!==this.config.clientId)throw new Error("Invalid audience");let S=(await this.fetchJWKS()).keys.find(A=>A.kid===r.kid);if(!S)throw new Error("No matching public key found");if(!await this.verifySignature(e,S))throw new Error("Invalid signature");return a}async verifyAccessToken(e){let t=await fetch(this.urlBuilder.buildIntrospectionUrl(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Bearer ${e}`},body:new URLSearchParams({token:e})}),n=await t.json();if(!t.ok||!n.active)throw new Error("Token verification failed");return n}async fetchJWKS(){let e=await fetch(this.urlBuilder.buildJWKSUrl());if(!e.ok)throw new Error("Failed to fetch JWKS");return await e.json()}async verifySignature(e,t){try{let n=await crypto.subtle.importKey("jwk",t,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]),[r,a,o]=e.split(".");if(!o)throw new Error("Token signature is missing");let l=(await Promise.resolve().then(()=>(m(),x))).CryptoUtils.base64UrlToArrayBuffer(o),M=new TextEncoder().encode(`${r}.${a}`);return await crypto.subtle.verify("RSASSA-PKCS1-v1_5",n,l,M)}catch(n){return console.error("Signature verification error:",n),false}}},y=class{constructor(){this.popup=null;this.checkInterval=null;}open(e,t){let a=(screen.width-500)/2,o=(screen.height-600)/2;this.popup=window.open(e,"BjPassAuth",`width=500,height=600,top=${o},left=${a},resizable=yes,scrollbars=yes`),this.checkInterval=window.setInterval(()=>{this.popup&&this.popup.closed&&(this.close(),t?.());},500);}close(){this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null),this.popup&&!this.popup.closed&&this.popup.close(),this.popup=null;}isOpen(){return !!(this.popup&&!this.popup.closed)}},f=class{static getErrorMessage(e,t){let n="Erreur d'authentification",r={invalid_token:"Token invalide ou expir\xE9",unsuported_grant_type_error:"Type de subvention OAuth invalide",insufficient_scope:"Permissions insuffisantes",invalid_grant:"Code d'autorisation invalide ou expir\xE9",access_denied:"Authentification annul\xE9e",invalid_request:"Requ\xEAte invalide",invalid_scope:"Permissions invalides",server_error:"Erreur du serveur",popup_closed:"La fen\xEAtre d'authentification a \xE9t\xE9 ferm\xE9e",browser_error:"Navigateur non support\xE9",backend_error:"Erreur du backend",token_error:"Erreur de validation du token",token_exchange_error:"Erreur lors de l'\xE9change"};return r[e]&&(n=r[e]),t&&(n+=`: ${t}`),n}};var u=class{constructor(e){this.element=null;this.eventListeners=new Map;this.container=e;}createElement(e,t="",n=""){let r=document.createElement(e);return t&&(r.className=t),n&&(r.innerHTML=n),r}addEventListeners(e,t){Object.entries(t).forEach(([n,r])=>{e.addEventListener(n,r),this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push({event:n,handler:r});});}removeEventListeners(){this.eventListeners.forEach((e,t)=>{e.forEach(({event:n,handler:r})=>t.removeEventListener(n,r));}),this.eventListeners.clear();}destroy(){this.removeEventListeners(),this.element?.parentNode&&this.element.parentNode.removeChild(this.element);}render(){throw new Error("render() must be implemented by subclass")}show(){this.element&&(this.element.style.display="block");}hide(){this.element&&(this.element.style.display="none");}},E=class extends u{constructor(t,n,r){super(t);this.config=n;this.onEnvironmentChange=r;this.render();}render(){if(!this.config.get().ui.showEnvSelector)return;let t=this.config.get().environment,n=this.config.getEnvironments().map(r=>`
      <label>
        <input type="radio" name="env" value="${r}" ${r===t?"checked":""}>
        ${r.charAt(0).toUpperCase()+r.slice(1)}
      </label>
    `).join("");this.element=this.createElement("div","bjpass-env-selector",`
      <div class="env-selector-label">Environment:</div>
      ${n}
    `),this.element.querySelectorAll('input[name="env"]').forEach(r=>{this.addEventListeners(r,{change:a=>this.onEnvironmentChange(a.target.value)});}),this.container.appendChild(this.element);}},k=class extends u{constructor(t,n,r){super(t);this.config=n;this.onLogin=r;this.render();}render(){this.element=this.createElement("button","bjpass-login-btn","Se connecter"),this.element.type="button",this.element.style.cssText=`
      width: 100%;
      padding: 12px 24px;
      background-color: ${this.config.ui.primaryColor};
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    `,this.addEventListeners(this.element,{click:()=>this.onLogin(),mouseover:()=>{this.element&&(this.element.style.opacity="0.9");},mouseout:()=>{this.element&&(this.element.style.opacity="1");}}),this.container.appendChild(this.element);}setLoading(t){this.element&&(this.element.disabled=t,this.element.innerHTML=t?"Connexion...":"Se connecter");}},b=class extends u{constructor(e){super(e),this.render();}render(){this.element=this.createElement("div","bjpass-loading",`
      <div class="spinner"></div>
      <div class="loading-text">Authentification en cours...</div>
    `),this.element.style.cssText="display:none;text-align:center;padding:20px;";let e=this.element.querySelector(".spinner");if(e.style.cssText="border:3px solid #f3f3f3;border-radius:50%;border-top:3px solid #0066cc;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 10px;",!document.getElementById("bjpass-spinner-styles")){let t=document.createElement("style");t.id="bjpass-spinner-styles",t.textContent="@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}",document.head.appendChild(t);}this.container.appendChild(this.element);}},C=class extends u{constructor(e){super(e),this.render();}render(){this.element=this.createElement("div","bjpass-error"),this.element.style.cssText="display:none;padding:12px;margin:10px 0;background-color:#fee;border:1px solid #fcc;border-radius:4px;color:#c33;font-size:14px;",this.container.appendChild(this.element);}showError(e){this.element&&(this.element.textContent=e,this.show());}clearError(){this.element&&(this.element.textContent="",this.hide());}},w=class{constructor(e){this.config=e;this.container=null;this.components={};this.state={isLoading:false,error:null};}initialize(){if(this.container=document.querySelector(this.config.ui.container),!this.container)throw new Error(`Container ${this.config.ui.container} not found`);this.createMainContainer(),this.initializeComponents();}createMainContainer(){this.mainElement=document.createElement("div"),this.mainElement.className="bjpass-widget",this.mainElement.style.cssText="max-width:400px;margin:0 auto;padding:20px;border:1px solid #ddd;border-radius:8px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;";let e=document.createElement("h3");e.textContent="Authentification BjPass",e.style.cssText=`color:${this.config.ui.primaryColor};text-align:center;margin:0 0 20px;`,this.mainElement.appendChild(e),this.container.appendChild(this.mainElement);}initializeComponents(){this.components.envSelector=new E(this.mainElement,{get:()=>this.config,getEnvironments:()=>["test","production"]},this.onEnvironmentChange.bind(this)),this.components.loginButton=new k(this.mainElement,this.config,this.onLoginClick.bind(this)),this.components.loadingSpinner=new b(this.mainElement),this.components.errorDisplay=new C(this.mainElement);let e=document.createElement("p");e.textContent="Vous serez redirig\xE9 vers le service d'authentification s\xE9curis\xE9e",e.style.cssText="text-align:center;margin:15px 0 0;font-size:.9em;color:#666;",this.mainElement.appendChild(e);}setOnEnvironmentChange(e){this.onEnvironmentChangeCallback=e;}setOnLogin(e){this.onLoginCallback=e;}onEnvironmentChange(e){this.onEnvironmentChangeCallback?.(e);}onLoginClick(){this.onLoginCallback?.();}setState(e){this.state={...this.state,...e},this.updateUI();}updateUI(){this.state.isLoading?(this.components.loginButton.setLoading(true),this.components.loadingSpinner.show(),this.components.errorDisplay.clearError()):(this.components.loginButton.setLoading(false),this.components.loadingSpinner.hide(),this.state.error?this.components.errorDisplay.showError(this.state.error):this.components.errorDisplay.clearError());}destroy(){Object.values(this.components).forEach(e=>e?.destroy?.()),this.mainElement?.parentNode&&this.mainElement.parentNode.removeChild(this.mainElement);}};m();var g=class{constructor(e,t,n){this.config=e;this.popupManager=t;this.uiManager=n;}async exchangeCode(e,t){let n=await fetch(this.config.beUrl,{method:"POST",headers:{"Content-Type":"application/json",...this.config.header},body:JSON.stringify({code:e,state:t,redirect_uri:this.config.redirectUri,code_verifier:s.getItem("code_verifier")})});if(!n.ok){let r={};try{r=await n.json();}catch{}throw new Error(r.message||"\xC9chec de l'authentification")}return await n.json()}async exchangeCodeDirect(e,t,n){let r=s.getItem("code_verifier");if(!r)throw new Error("Missing code verifier");let a=await fetch(n.buildTokenUrl(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:e,redirect_uri:this.config.redirectUri,client_id:this.config.clientId,code_verifier:r})}),o=await a.json();if(!a.ok)throw new Error(o.error_description||"Failed to obtain token");return o}async handleBackendAuthResponse(e){e.status==="success"?await this.handleBackendAuthSuccess(e):this.handleBackendAuthError(e);}async handleBackendAuthSuccess(e){s.setItem("user",JSON.stringify(e.user)),s.setItem("success","true"),this.popupManager.close(),this.uiManager.setState({isLoading:false,error:null}),this.config.onSuccess?.({user:e.user,backendData:e,source:"backend"}),await this.verifyBackendStatus();}handleBackendAuthError(e){this.popupManager.close();let t=e.message||"Erreur d'authentification",n=e.error||"backend_error";this.uiManager.setState({isLoading:false,error:f.getErrorMessage(n,t)}),this.config.onError?.({error:n,error_description:t});}async verifyBackendStatus(){let e=new URL(this.config.backendEndpoints.status,this.config.backendUrl),t=await fetch(e.toString(),{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!t.ok)throw new Error(`Status check failed: ${t.status}`);let n=await t.json();if(n.authenticated)s.setItem("user",JSON.stringify(n.user)),s.setItem("authenticated","true");else throw s.clear(),new Error("User not authenticated on backend")}async startBackendAuthFlow(){if(!this.config.backendUrl)throw new Error("Backend URL not configured");let e=new URL(this.config.backendEndpoints.start,this.config.backendUrl);this.config.returnUrl&&e.searchParams.set("return_url",this.config.returnUrl),this.popupManager.open(e.toString(),()=>{this.uiManager.setState({isLoading:false}),s.getItem("success")||this.config.onError?.({error:"popup_closed",error_description:"La fen\xEAtre d'authentification a \xE9t\xE9 ferm\xE9e"});});}async getUserInfoFromBackend(){let e=new URL(this.config.backendEndpoints.user,this.config.backendUrl),t=await fetch(e.toString(),{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!t.ok)throw new Error(`User info request failed: ${t.status}`);return (await t.json()).user}async logoutFromBackend(){let e=new URL(this.config.backendEndpoints.logout,this.config.backendUrl),t=await fetch(e.toString(),{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!t.ok)throw new Error(`Backend logout failed: ${t.status}`)}},p=class{constructor(e={}){if(this.configManager=new v(e),this.uiManager=new w(this.configManager.get()),this.urlBuilder=new h(this.configManager.get()),this.tokenValidator=new d(this.configManager.get(),this.urlBuilder),this.popupManager=new y,this.backendClient=new g(this.configManager.get(),this.popupManager,this.uiManager),!("crypto"in globalThis)||!("subtle"in crypto))throw new Error("Browser not supported. Please use a modern browser.");this.initialize(),this.setupMessageListener();}initialize(){this.uiManager.initialize(),this.setupEventHandlers();}setupEventHandlers(){this.uiManager.setOnEnvironmentChange(e=>{this.configManager.updateConfig({environment:e}),this.urlBuilder=new h(this.configManager.get()),this.tokenValidator=new d(this.configManager.get(),this.urlBuilder),this.backendClient=new g(this.configManager.get(),this.popupManager,this.uiManager);}),this.uiManager.setOnLogin(()=>{this.startAuthFlow();});}setupMessageListener(){window.addEventListener("message",e=>{if(!this.isValidMessageOrigin(e.origin))return;let t=e.data;t&&t.type==="bjpass-auth-response"&&this.backendClient.handleBackendAuthResponse(t);});}isValidMessageOrigin(e){let t=this.configManager.get();return [t.backendOrigin,t.frontendOrigin].some(r=>r==="*"||r===e)}async startAuthFlow(){try{let e=this.configManager.get();this.uiManager.setState({isLoading:!0,error:null}),e.useBackend?await this.backendClient.startBackendAuthFlow():await this.startDirectAuthFlow();}catch(e){this.handleError("auth_flow_error",e?.message);}}async startDirectAuthFlow(){let e=this.configManager.get(),t=s.generateAndStoreAuthData(e.scope),n=await this.urlBuilder.buildAuthorizationUrl(t);this.popupManager.open(n,()=>{this.uiManager.setState({isLoading:false}),s.getItem("success")||this.handleError("popup_closed","La fen\xEAtre d'authentification a \xE9t\xE9 ferm\xE9e");});}async handlePopupResponse(e){try{let t=new URLSearchParams(e),n=t.get("code"),r=t.get("state"),a=t.get("error");if(a){this.handleError(a,t.get("error_description")||void 0);return}if(!n||!r){this.handleError("invalid_response","Code ou state manquant");return}let o=s.getItem("state");if(r!==o){this.handleError("invalid_state","Param\xE8tre state invalide");return}s.setItem("success","true"),this.popupManager.close(),await this.exchangeCodeForTokens(n,r);}catch(t){this.handleError("callback_error",t?.message);}}async exchangeCodeForTokens(e,t){try{let n=this.configManager.get(),r;if(n.beUrl)r=await this.backendClient.exchangeCode(e,t);else {this.handleError("unsuported_grant_type_error","Type de subvention OAuth non encore pris en charge.");return}await this.validateTokens(r.data),s.clear(),this.uiManager.setState({isLoading:!1,error:null}),n.onSuccess?.(r);}catch(n){this.handleError("token_exchange_error",n?.message);}}async validateTokens(e){let t=this.configManager.get();e.id_token&&t.scope.includes("openid")&&await this.tokenValidator.validateIdToken(e.id_token),t.verifyAccessToken&&e.access_token&&await this.tokenValidator.verifyAccessToken(e.access_token);}handleError(e,t){let n=f.getErrorMessage(e,t);this.uiManager.setState({isLoading:false,error:n}),this.configManager.get().onError?.({error:e,error_description:t});}async getUserInfo(){let e=this.configManager.get();if(e.useBackend)try{return await new g(e,this.popupManager,this.uiManager).getUserInfoFromBackend()}catch{}let t=s.getItem("user");return t?JSON.parse(t):null}async logout(){let e=this.configManager.get();if(e.useBackend)try{await new g(e,this.popupManager,this.uiManager).logoutFromBackend();}catch{}s.clear(),this.uiManager.setState({isLoading:false,error:null}),this.configManager.get().onLogout?.();}destroy(){this.popupManager.close(),this.uiManager.destroy(),s.clear();}refresh(){this.uiManager.destroy(),this.initialize?.();}getConfig(){return this.configManager.get()}updateConfig(e){this.configManager.updateConfig(e),this.urlBuilder=new h(this.configManager.get()),this.tokenValidator=new d(this.configManager.get(),this.urlBuilder);}};typeof window<"u"&&(window.BjPassAuthWidget=p,window.createBjPassWidget=(i={})=>new p(i),document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("[data-bjpass-widget]").forEach(e=>{try{let t=e.dataset.bjpassWidget||"{}",n=JSON.parse(t);(n.ui||(n.ui={})).container=`#${e.id}`,new p(n);}catch(t){console.error("Failed to initialize BjPass widget:",t);}});}));var H=p;exports.BackendClient=g;exports.BjPassAuthWidget=p;exports.default=H;//# sourceMappingURL=index.cjs.map
//# sourceMappingURL=index.cjs.map