{"version":3,"sources":["../src/utils.ts","../src/core.ts","../src/ui.ts","../src/index.ts"],"names":["utils_exports","__export","CryptoUtils","SessionManager","init_utils","__esmMin","length","array","b","codeVerifier","data","digest","base64Url","padding","base64","rawData","output","i","key","value","scope","state","nonce","ConfigManager","userConfig","env","envConfig","newConfig","OAuthUrlBuilder","config","authData","codeChallenge","base","params","TokenValidator","urlBuilder","idToken","header","payload","decodedHeader","decodedPayload","now","savedNonce","publicKey","accessToken","response","token","jwk","signature","signatureData","e","PopupManager","url","onClose","left","top","ErrorHandler","error","description","errorMessage","errorMessages","UIComponent","container","tag","className","innerHTML","element","events","event","handler","listeners","EnvironmentSelector","onEnvironmentChange","currentEnv","envOptions","radio","LoginButton","onLogin","isLoading","LoadingSpinner","spinner","style","ErrorDisplay","message","UIManager","title","helpText","cb","environment","newState","c","BackendClient","popupManager","uiManager","code","errorData","statusUrl","statusData","startUrl","userUrl","logoutUrl","BjPassAuthWidget","origin","allowed","authUrl","queryParams","savedState","tokenData","errorCode","userData","cfgRaw","index_default"],"mappings":"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","file":"index.cjs","sourcesContent":["\nexport class CryptoUtils {\n  static generateRandomString(length: number): string {\n    const array = new Uint8Array(length);\n    crypto.getRandomValues(array);\n    return Array.from(array, (b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n  }\n\n  static async generateCodeChallenge(codeVerifier: string): Promise<string> {\n    const encoder = new TextEncoder();\n    const data = encoder.encode(codeVerifier);\n    const digest = await crypto.subtle.digest(\"SHA-256\", data);\n    return btoa(String.fromCharCode(...new Uint8Array(digest)))\n      .replace(/\\+/g, \"-\")\n      .replace(/\\//g, \"_\")\n      .replace(/=+$/, \"\");\n  }\n\n  static base64UrlToArrayBuffer(base64Url: string): ArrayBuffer {\n    const padding = \"=\".repeat((4 - (base64Url.length % 4)) % 4);\n    const base64 = base64Url.replace(/-/g, \"+\").replace(/_/g, \"/\") + padding;\n    const rawData = atob(base64);\n    const output = new Uint8Array(rawData.length);\n    for (let i = 0; i < rawData.length; ++i) {\n      output[i] = rawData.charCodeAt(i);\n    }\n    return output;\n  }\n\n  static checkBrowserCompatibility(): boolean {\n    return !!(globalThis.crypto && globalThis.crypto.subtle);\n  }\n}\n\nexport class SessionManager {\n  static setItem(key: string, value: string): void {\n    sessionStorage.setItem(`tx_auth_${key}`, value);\n  }\n  static getItem(key: string): string | null {\n    return sessionStorage.getItem(`tx_auth_${key}`);\n  }\n  static removeItem(key: string): void {\n    sessionStorage.removeItem(`tx_auth_${key}`);\n  }\n  static clear(): void {\n    const keys = [\"state\", \"code_verifier\", \"nonce\", \"success\", \"authenticated\", \"user\"];\n    keys.forEach((key) => this.removeItem(key));\n  }\n  static generateAndStoreAuthData(scope: string): { state: string; nonce?: string; codeVerifier: string } {\n    const state = CryptoUtils.generateRandomString(32);\n    const nonce = CryptoUtils.generateRandomString(32);\n    const codeVerifier = CryptoUtils.generateRandomString(64);\n    this.setItem(\"state\", state);\n    this.setItem(\"code_verifier\", codeVerifier);\n    if (scope.includes(\"openid\")) {\n      this.setItem(\"nonce\", nonce);\n      return { state, nonce, codeVerifier };\n    }\n    return { state, codeVerifier };\n  }\n}\n","\nimport { AuthConfig, JWKSResponse, BackendAuthResponse, TokenResponse } from \"./types\";\nimport { CryptoUtils, SessionManager } from \"./utils\";\n\nexport class ConfigManager {\n  private environments = {\n    test: {\n      baseUrl: \"https://test-tx-pki.gouv.bj\",\n      defaultAuthServer: \"main-as\",\n    },\n    production: {\n      baseUrl: \"https://tx-pki.gouv.bj\",\n      defaultAuthServer: \"main-as\",\n    },\n  } as const;\n\n  private defaultConfig: AuthConfig = {\n    environment: \"test\",\n    clientId: \"\",\n    authServer: \"\",\n    scope: \"openid profile\",\n    redirectUri: \"http://127.0.0.1:5500/examples/redirect.html\",\n    pkce: true,\n    verifyAccessToken: false,\n    tokenVerificationScopes: [\"urn:safelayer:eidas:oauth:token:introspect\"],\n    beUrl: \"\",\n    beBearer: \"\",\n    header: {},\n    ui: {\n      showEnvSelector: true,\n      container: \"#bjpass-auth-container\",\n      language: \"fr\",\n      primaryColor: \"#0066cc\",\n      theme: \"default\",\n    },\n    backendUrl: \"https://your-backend.com\",\n    backendEndpoints: {\n      start: \"/auth/start\",\n      status: \"/auth/api/status\",\n      user: \"/auth/api/user\",\n      logout: \"/auth/api/logout\",\n      refresh: \"/auth/api/refresh\",\n    },\n    frontendOrigin: \"https://your-frontend.com\",\n    backendOrigin: \"https://your-backend.com\",\n    useBackend: true,\n    popupMode: true,\n    autoClosePopup: true,\n  };\n\n  private config: AuthConfig;\n  private resolvedConfig: AuthConfig & { baseUrl: string };\n\n  constructor(userConfig: Partial<AuthConfig> = {}) {\n    this.config = { ...this.defaultConfig, ...userConfig };\n    this.resolvedConfig = this.applyEnvironmentConfig();\n  }\n\n  private applyEnvironmentConfig() {\n    const env = this.config.environment || \"test\";\n    const envConfig = this.environments[env as keyof typeof this.environments] || this.environments.test;\n    return {\n      ...this.config,\n      baseUrl: envConfig.baseUrl,\n      authServer: this.config.authServer || envConfig.defaultAuthServer,\n    };\n  }\n\n  updateConfig(newConfig: Partial<AuthConfig>) {\n    this.config = { ...this.config, ...newConfig };\n    this.resolvedConfig = this.applyEnvironmentConfig();\n  }\n\n  get(): AuthConfig & { baseUrl: string } {\n    return this.resolvedConfig;\n  }\n\n  getEnvironments(): string[] {\n    return Object.keys(this.environments);\n  }\n}\n\nexport class OAuthUrlBuilder {\n  constructor(private config: AuthConfig & { baseUrl: string }) {}\n  async buildAuthorizationUrl(authData: { state: string; nonce?: string; codeVerifier: string }): Promise<string> {\n    const { state, nonce, codeVerifier } = authData;\n    const codeChallenge = await CryptoUtils.generateCodeChallenge(codeVerifier);\n    const base = new URL(`${this.config.baseUrl}/trustedx-authserver/oauth`);\n    if (this.config.authServer) {\n      base.pathname += `/${encodeURIComponent(this.config.authServer)}`;\n    }\n    const params = new URLSearchParams({\n      response_type: \"code\",\n      client_id: this.config.clientId,\n      redirect_uri: this.config.redirectUri,\n      scope: this.config.scope.split(\"+\").join(\" \"),\n      state,\n      code_challenge: codeChallenge,\n      code_challenge_method: \"S256\",\n      prompt: \"login\",\n    });\n    if (this.config.scope.includes(\"openid\") && nonce) params.set(\"nonce\", nonce);\n    base.search = params.toString();\n    return base.toString();\n  }\n  buildTokenUrl(): string {\n    return `${this.config.baseUrl}/trustedx-authserver/oauth/${encodeURIComponent(this.config.authServer)}/token`;\n  }\n  buildJWKSUrl(): string {\n    return `${this.config.baseUrl}/trustedx-authserver/oauth/keys`;\n  }\n  buildIntrospectionUrl(): string {\n    return `${this.config.baseUrl}/trustedx-authserver/oauth/token/verify`;\n  }\n}\n\nexport class TokenValidator {\n  constructor(private config: AuthConfig, private urlBuilder: OAuthUrlBuilder) {}\n  async validateIdToken(idToken: string): Promise<unknown> {\n    const [header, payload] = idToken.split(\".\");\n    if (!header || !payload) {\n      throw new Error(\"Invalid idToken format\");\n    }\n    const decodedHeader = JSON.parse(atob(header));\n    const decodedPayload = JSON.parse(atob(payload));\n    const now = Math.floor(Date.now() / 1000);\n    const savedNonce = SessionManager.getItem(\"nonce\");\n    if (decodedPayload.exp < now) throw new Error(\"Token expired\");\n    if (decodedPayload.nonce !== savedNonce) throw new Error(\"Invalid nonce\");\n    if (decodedPayload.aud !== this.config.clientId) throw new Error(\"Invalid audience\");\n    const jwks = await this.fetchJWKS();\n    const publicKey = jwks.keys.find((key) => key.kid === decodedHeader.kid);\n    if (!publicKey) throw new Error(\"No matching public key found\");\n    const isValid = await this.verifySignature(idToken, publicKey);\n    if (!isValid) throw new Error(\"Invalid signature\");\n    return decodedPayload;\n  }\n  async verifyAccessToken(accessToken: string): Promise<unknown> {\n    const response = await fetch(this.urlBuilder.buildIntrospectionUrl(), {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n        \"Authorization\": `Bearer ${accessToken}`\n      },\n      body: new URLSearchParams({ token: accessToken } as any)\n    });\n    const data = await response.json();\n    if (!response.ok || !data.active) {\n      throw new Error(\"Token verification failed\");\n    }\n    return data;\n  }\n  private async fetchJWKS(): Promise<JWKSResponse> {\n    const response = await fetch(this.urlBuilder.buildJWKSUrl());\n    if (!response.ok) throw new Error(\"Failed to fetch JWKS\");\n    return await response.json();\n  }\n  private async verifySignature(token: string, jwk: any): Promise<boolean> {\n    try {\n      const key = await crypto.subtle.importKey(\n        \"jwk\",\n        jwk,\n        { name: \"RSASSA-PKCS1-v1_5\", hash: { name: \"SHA-256\" } },\n        false,\n        [\"verify\"]\n      );\n      const [header, payload, signature] = token.split(\".\");\n      if (!signature) {\n        throw new Error(\"Token signature is missing\");\n      }\n      const signatureData = (await import(\"./utils\")).CryptoUtils.base64UrlToArrayBuffer(signature);\n      const data = new TextEncoder().encode(`${header}.${payload}`);\n      return await crypto.subtle.verify(\"RSASSA-PKCS1-v1_5\", key, signatureData, data);\n    } catch (e) {\n      console.error(\"Signature verification error:\", e);\n      return false;\n    }\n  }\n}\n\nexport class PopupManager {\n  private popup: Window | null = null;\n  private checkInterval: number | null = null;\n  open(url: string, onClose?: () => void) {\n    const width = 500, height = 600;\n    const left = (screen.width - width) / 2;\n    const top = (screen.height - height) / 2;\n    this.popup = window.open(\n      url,\n      \"BjPassAuth\",\n      `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes`\n    );\n    this.checkInterval = window.setInterval(() => {\n      if (this.popup && this.popup.closed) {\n        this.close();\n        onClose?.();\n      }\n    }, 500);\n  }\n  close() {\n    if (this.checkInterval) {\n      clearInterval(this.checkInterval);\n      this.checkInterval = null;\n    }\n    if (this.popup && !this.popup.closed) this.popup.close();\n    this.popup = null;\n  }\n  isOpen() {\n    return !!(this.popup && !this.popup.closed);\n  }\n}\n\nexport class ErrorHandler {\n  static getErrorMessage(error: string, description?: string): string {\n    let errorMessage = \"Erreur d'authentification\";\n    const errorMessages: Record<string, string> = {\n      invalid_token: \"Token invalide ou expiré\",\n      unsuported_grant_type_error: \"Type de subvention OAuth invalide\",\n      insufficient_scope: \"Permissions insuffisantes\",\n      invalid_grant: \"Code d'autorisation invalide ou expiré\",\n      access_denied: \"Authentification annulée\",\n      invalid_request: \"Requête invalide\",\n      invalid_scope: \"Permissions invalides\",\n      server_error: \"Erreur du serveur\",\n      popup_closed: \"La fenêtre d'authentification a été fermée\",\n      browser_error: \"Navigateur non supporté\",\n      backend_error: \"Erreur du backend\",\n      token_error: \"Erreur de validation du token\",\n      token_exchange_error: \"Erreur lors de l'échange\",\n    };\n    if (errorMessages[error]) errorMessage = errorMessages[error];\n    if (description) errorMessage += `: ${description}`;\n    return errorMessage;\n  }\n}\n","\nimport type { AuthConfig } from \"./types\";\n\nclass UIComponent {\n  protected container: HTMLElement;\n  protected element: HTMLElement | null = null;\n  private eventListeners = new Map<HTMLElement, { event: string; handler: EventListener }[]>();\n\n  constructor(container: HTMLElement) {\n    this.container = container;\n  }\n  protected createElement<T extends keyof HTMLElementTagNameMap>(tag: T, className = \"\", innerHTML = \"\") {\n    const element = document.createElement(tag);\n    if (className) element.className = className;\n    if (innerHTML) element.innerHTML = innerHTML;\n    return element as HTMLElementTagNameMap[T];\n  }\n  protected addEventListeners(element: HTMLElement, events: Record<string, EventListener>) {\n    Object.entries(events).forEach(([event, handler]) => {\n      element.addEventListener(event, handler);\n      if (!this.eventListeners.has(element)) this.eventListeners.set(element, []);\n      this.eventListeners.get(element)!.push({ event, handler });\n    });\n  }\n  removeEventListeners() {\n    this.eventListeners.forEach((listeners, element) => {\n      listeners.forEach(({ event, handler }) => element.removeEventListener(event, handler));\n    });\n    this.eventListeners.clear();\n  }\n  destroy() {\n    this.removeEventListeners();\n    if (this.element?.parentNode) this.element.parentNode.removeChild(this.element);\n  }\n  render(): void { throw new Error(\"render() must be implemented by subclass\"); }\n  show() { if (this.element) this.element.style.display = \"block\"; }\n  hide() { if (this.element) this.element.style.display = \"none\"; }\n}\n\nexport class EnvironmentSelector extends UIComponent {\n  constructor(container: HTMLElement, private config: { get(): AuthConfig & { baseUrl: string }; getEnvironments(): string[] }, private onEnvironmentChange: (env: string) => void) {\n    super(container);\n    this.render();\n  }\n  render() {\n    if (!this.config.get().ui.showEnvSelector) return;\n    const currentEnv = this.config.get().environment;\n    const envOptions = this.config.getEnvironments().map(env => `\n      <label>\n        <input type=\"radio\" name=\"env\" value=\"${env}\" ${env === currentEnv ? \"checked\" : \"\"}>\n        ${env.charAt(0).toUpperCase() + env.slice(1)}\n      </label>\n    `).join(\"\");\n    this.element = this.createElement(\"div\", \"bjpass-env-selector\", `\n      <div class=\"env-selector-label\">Environment:</div>\n      ${envOptions}\n    `);\n    this.element.querySelectorAll('input[name=\"env\"]').forEach((radio) => {\n      this.addEventListeners(radio as HTMLInputElement, { change: (e: Event) => this.onEnvironmentChange((e.target as HTMLInputElement).value) });\n    });\n    this.container.appendChild(this.element);\n  }\n}\n\nexport class LoginButton extends UIComponent {\n  constructor(container: HTMLElement, private config: AuthConfig, private onLogin: () => void) {\n    super(container);\n    this.render();\n  }\n  render() {\n    this.element = this.createElement(\"button\", \"bjpass-login-btn\", \"Se connecter\");\n    (this.element as HTMLButtonElement).type = \"button\";\n    this.element.style.cssText = `\n      width: 100%;\n      padding: 12px 24px;\n      background-color: ${this.config.ui.primaryColor};\n      color: white;\n      border: none;\n      border-radius: 6px;\n      font-size: 16px;\n      cursor: pointer;\n      transition: background-color 0.2s;\n    `;\n    this.addEventListeners(this.element, {\n      click: () => this.onLogin(),\n      mouseover: () => { if (this.element) this.element.style.opacity = \"0.9\"; },\n      mouseout: () => { if (this.element) this.element.style.opacity = \"1\"; }\n    });\n    this.container.appendChild(this.element);\n  }\n  setLoading(isLoading: boolean) {\n    if (!this.element) return;\n    (this.element as HTMLButtonElement).disabled = isLoading;\n    this.element.innerHTML = isLoading ? \"Connexion...\" : \"Se connecter\";\n  }\n}\n\nexport class LoadingSpinner extends UIComponent {\n  constructor(container: HTMLElement) { super(container); this.render(); }\n  render() {\n    this.element = this.createElement(\"div\", \"bjpass-loading\", `\n      <div class=\"spinner\"></div>\n      <div class=\"loading-text\">Authentification en cours...</div>\n    `);\n    this.element.style.cssText = \"display:none;text-align:center;padding:20px;\";\n    const spinner = this.element.querySelector(\".spinner\") as HTMLElement;\n    spinner.style.cssText = \"border:3px solid #f3f3f3;border-radius:50%;border-top:3px solid #0066cc;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 10px;\";\n    if (!document.getElementById(\"bjpass-spinner-styles\")) {\n      const style = document.createElement(\"style\");\n      style.id = \"bjpass-spinner-styles\";\n      style.textContent = \"@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}\";\n      document.head.appendChild(style);\n    }\n    this.container.appendChild(this.element);\n  }\n}\n\nexport class ErrorDisplay extends UIComponent {\n  constructor(container: HTMLElement) { super(container); this.render(); }\n  render() {\n    this.element = this.createElement(\"div\", \"bjpass-error\");\n    this.element.style.cssText = \"display:none;padding:12px;margin:10px 0;background-color:#fee;border:1px solid #fcc;border-radius:4px;color:#c33;font-size:14px;\";\n    this.container.appendChild(this.element);\n  }\n  showError(message: string) { if (!this.element) return; this.element.textContent = message; this.show(); }\n  clearError() { if (!this.element) return; this.element.textContent = \"\"; this.hide(); }\n}\n\nexport class UIManager {\n  private container: HTMLElement | null = null;\n  private components: any = {};\n  private state = { isLoading: false, error: null as string | null };\n  private mainElement!: HTMLElement;\n  constructor(private config: AuthConfig & { baseUrl: string }) {}\n  initialize() {\n    this.container = document.querySelector(this.config.ui.container);\n    if (!this.container) throw new Error(`Container ${this.config.ui.container} not found`);\n    this.createMainContainer();\n    this.initializeComponents();\n  }\n  private createMainContainer() {\n    this.mainElement = document.createElement(\"div\");\n    this.mainElement.className = \"bjpass-widget\";\n    this.mainElement.style.cssText = \"max-width:400px;margin:0 auto;padding:20px;border:1px solid #ddd;border-radius:8px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;\";\n    const title = document.createElement(\"h3\");\n    title.textContent = \"Authentification BjPass\";\n    title.style.cssText = `color:${this.config.ui.primaryColor};text-align:center;margin:0 0 20px;`;\n    this.mainElement.appendChild(title);\n    this.container!.appendChild(this.mainElement);\n  }\n  private initializeComponents() {\n    this.components.envSelector = new EnvironmentSelector(this.mainElement, { get: () => this.config, getEnvironments: () => [\"test\",\"production\"] }, this.onEnvironmentChange.bind(this));\n    this.components.loginButton = new LoginButton(this.mainElement, this.config, this.onLoginClick.bind(this));\n    this.components.loadingSpinner = new LoadingSpinner(this.mainElement);\n    this.components.errorDisplay = new ErrorDisplay(this.mainElement);\n    const helpText = document.createElement(\"p\");\n    helpText.textContent = \"Vous serez redirigé vers le service d'authentification sécurisée\";\n    helpText.style.cssText = \"text-align:center;margin:15px 0 0;font-size:.9em;color:#666;\";\n    this.mainElement.appendChild(helpText);\n  }\n  setOnEnvironmentChange(cb: (env: string) => void) { (this as any).onEnvironmentChangeCallback = cb; }\n  setOnLogin(cb: () => void) { (this as any).onLoginCallback = cb; }\n  private onEnvironmentChange(environment: string) { (this as any).onEnvironmentChangeCallback?.(environment); }\n  private onLoginClick() { (this as any).onLoginCallback?.(); }\n  setState(newState: Partial<{ isLoading: boolean; error: string | null }>) {\n    this.state = { ...this.state, ...newState };\n    this.updateUI();\n  }\n  private updateUI() {\n    if (this.state.isLoading) {\n      this.components.loginButton.setLoading(true);\n      this.components.loadingSpinner.show();\n      this.components.errorDisplay.clearError();\n    } else {\n      this.components.loginButton.setLoading(false);\n      this.components.loadingSpinner.hide();\n      if (this.state.error) this.components.errorDisplay.showError(this.state.error);\n      else this.components.errorDisplay.clearError();\n    }\n  }\n  destroy() {\n    Object.values(this.components).forEach((c: any) => c?.destroy?.());\n    if (this.mainElement?.parentNode) this.mainElement.parentNode.removeChild(this.mainElement);\n  }\n}\nexport { UIComponent };\n","\nimport type { AuthConfig, BackendAuthResponse, TokenResponse } from \"./types\";\nimport { ConfigManager, OAuthUrlBuilder, TokenValidator, PopupManager, ErrorHandler } from \"./core\";\nimport { UIManager } from \"./ui\";\nimport { SessionManager } from \"./utils\";\n\nexport class BackendClient {\n  constructor(private config: AuthConfig & { baseUrl: string }, private popupManager: PopupManager, private uiManager: UIManager) {}\n\n  async exchangeCode(code: string, state: string) {\n    const response = await fetch(this.config.beUrl, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\", ...this.config.header },\n      body: JSON.stringify({\n        code,\n        state,\n        redirect_uri: this.config.redirectUri,\n        code_verifier: SessionManager.getItem(\"code_verifier\"),\n      }),\n    });\n    if (!response.ok) {\n      let errorData: any = {};\n      try { errorData = await response.json(); } catch {}\n      throw new Error(errorData.message || \"Échec de l'authentification\");\n    }\n    return await response.json();\n  }\n\n  async exchangeCodeDirect(code: string, state: string, urlBuilder: OAuthUrlBuilder) {\n    const codeVerifier = SessionManager.getItem(\"code_verifier\");\n    if (!codeVerifier) throw new Error(\"Missing code verifier\");\n    const response = await fetch(urlBuilder.buildTokenUrl(), {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n      body: new URLSearchParams({\n        grant_type: \"authorization_code\",\n        code,\n        redirect_uri: this.config.redirectUri,\n        client_id: this.config.clientId,\n        code_verifier: codeVerifier,\n      } as any),\n    });\n    const data = await response.json();\n    if (!response.ok) throw new Error(data.error_description || \"Failed to obtain token\");\n    return data as TokenResponse;\n  }\n\n  async handleBackendAuthResponse(data: BackendAuthResponse) {\n    if ((data as any).status === \"success\") {\n      await this.handleBackendAuthSuccess(data as any);\n    } else {\n      this.handleBackendAuthError(data as any);\n    }\n  }\n\n  private async handleBackendAuthSuccess(data: any) {\n    SessionManager.setItem(\"user\", JSON.stringify(data.user));\n    SessionManager.setItem(\"success\", \"true\");\n    this.popupManager.close();\n    this.uiManager.setState({ isLoading: false, error: null });\n    this.config.onSuccess?.({ user: data.user, backendData: data, source: \"backend\" });\n    await this.verifyBackendStatus();\n  }\n\n  private handleBackendAuthError(data: any) {\n    this.popupManager.close();\n    const message = data.message || \"Erreur d'authentification\";\n    const error = data.error || \"backend_error\";\n    this.uiManager.setState({ isLoading: false, error: ErrorHandler.getErrorMessage(error, message) });\n    this.config.onError?.({ error, error_description: message });\n  }\n\n  async verifyBackendStatus() {\n    const statusUrl = new URL(this.config.backendEndpoints.status, this.config.backendUrl);\n    const response = await fetch(statusUrl.toString(), {\n      method: \"GET\",\n      credentials: \"include\",\n      headers: { Accept: \"application/json\", \"Content-Type\": \"application/json\" },\n    });\n    if (!response.ok) throw new Error(`Status check failed: ${response.status}`);\n    const statusData = await response.json();\n    if (statusData.authenticated) {\n      SessionManager.setItem(\"user\", JSON.stringify(statusData.user));\n      SessionManager.setItem(\"authenticated\", \"true\");\n    } else {\n      SessionManager.clear();\n      throw new Error(\"User not authenticated on backend\");\n    }\n  }\n\n  async startBackendAuthFlow() {\n    if (!this.config.backendUrl) throw new Error(\"Backend URL not configured\");\n    const startUrl = new URL(this.config.backendEndpoints.start, this.config.backendUrl);\n    if (this.config.returnUrl) startUrl.searchParams.set(\"return_url\", this.config.returnUrl);\n    this.popupManager.open(startUrl.toString(), () => {\n      this.uiManager.setState({ isLoading: false });\n      if (!SessionManager.getItem(\"success\")) {\n        this.config.onError?.({ error: \"popup_closed\", error_description: \"La fenêtre d'authentification a été fermée\" });\n      }\n    });\n  }\n\n  async getUserInfoFromBackend() {\n    const userUrl = new URL(this.config.backendEndpoints.user, this.config.backendUrl);\n    const response = await fetch(userUrl.toString(), {\n      method: \"GET\",\n      credentials: \"include\",\n      headers: { Accept: \"application/json\", \"Content-Type\": \"application/json\" },\n    });\n    if (!response.ok) throw new Error(`User info request failed: ${response.status}`);\n    const userData = await response.json();\n    return userData.user;\n  }\n\n  async logoutFromBackend() {\n    const logoutUrl = new URL(this.config.backendEndpoints.logout, this.config.backendUrl);\n    const response = await fetch(logoutUrl.toString(), {\n      method: \"POST\",\n      credentials: \"include\",\n      headers: { Accept: \"application/json\", \"Content-Type\": \"application/json\" },\n    });\n    if (!response.ok) throw new Error(`Backend logout failed: ${response.status}`);\n  }\n}\n\nexport class BjPassAuthWidget {\n  private configManager: ConfigManager;\n  private uiManager: UIManager;\n  private urlBuilder: OAuthUrlBuilder;\n  private tokenValidator: TokenValidator;\n  private backendClient: BackendClient;\n  private popupManager: PopupManager;\n\n  constructor(config: Partial<AuthConfig> = {}) {\n    this.configManager = new ConfigManager(config);\n    this.uiManager = new UIManager(this.configManager.get());\n    this.urlBuilder = new OAuthUrlBuilder(this.configManager.get());\n    this.tokenValidator = new TokenValidator(this.configManager.get(), this.urlBuilder);\n    this.popupManager = new PopupManager();\n    this.backendClient = new BackendClient(this.configManager.get(), this.popupManager, this.uiManager);\n    if (!(\"crypto\" in globalThis) || !(\"subtle\" in crypto)) {\n      throw new Error(\"Browser not supported. Please use a modern browser.\");\n    }\n    this.initialize();\n    this.setupMessageListener();\n  }\n\n  private initialize() {\n    this.uiManager.initialize();\n    this.setupEventHandlers();\n  }\n\n  private setupEventHandlers() {\n    (this.uiManager as any).setOnEnvironmentChange((environment: string) => {\n      this.configManager.updateConfig({ environment } as any);\n      this.urlBuilder = new OAuthUrlBuilder(this.configManager.get());\n      this.tokenValidator = new TokenValidator(this.configManager.get(), this.urlBuilder);\n      this.backendClient = new BackendClient(this.configManager.get(), this.popupManager, this.uiManager);\n    });\n    (this.uiManager as any).setOnLogin(() => { this.startAuthFlow(); });\n  }\n\n  private setupMessageListener() {\n    window.addEventListener(\"message\", (event: MessageEvent) => {\n      if (!this.isValidMessageOrigin(event.origin)) return;\n      const data = event.data as BackendAuthResponse;\n      if (data && (data as any).type === \"bjpass-auth-response\") {\n        this.backendClient.handleBackendAuthResponse(data);\n      }\n    });\n  }\n\n  private isValidMessageOrigin(origin: string) {\n    const config = this.configManager.get();\n    const allowedOrigins = [config.backendOrigin, config.frontendOrigin];\n    return allowedOrigins.some((allowed) => allowed === \"*\" || allowed === origin);\n  }\n\n  async startAuthFlow() {\n    try {\n      const config = this.configManager.get();\n      this.uiManager.setState({ isLoading: true, error: null });\n      if (config.useBackend) {\n        await this.backendClient.startBackendAuthFlow();\n      } else {\n        await this.startDirectAuthFlow();\n      }\n    } catch (error: any) {\n      this.handleError(\"auth_flow_error\", error?.message);\n    }\n  }\n\n  private async startDirectAuthFlow() {\n    const config = this.configManager.get();\n    const authData = SessionManager.generateAndStoreAuthData(config.scope);\n    const authUrl = await this.urlBuilder.buildAuthorizationUrl(authData as any);\n    this.popupManager.open(authUrl, () => {\n      this.uiManager.setState({ isLoading: false });\n      if (!SessionManager.getItem(\"success\")) {\n        this.handleError(\"popup_closed\", \"La fenêtre d'authentification a été fermée\");\n      }\n    });\n  }\n\n  async handlePopupResponse(queryParams: string) {\n    try {\n      const params = new URLSearchParams(queryParams);\n      const code = params.get(\"code\");\n      const state = params.get(\"state\");\n      const error = params.get(\"error\");\n      if (error) { this.handleError(error, params.get(\"error_description\") || undefined); return; }\n      if (!code || !state) { this.handleError(\"invalid_response\", \"Code ou state manquant\"); return; }\n      const savedState = SessionManager.getItem(\"state\");\n      if (state !== savedState) { this.handleError(\"invalid_state\", \"Paramètre state invalide\"); return; }\n      SessionManager.setItem(\"success\", \"true\");\n      this.popupManager.close();\n      await this.exchangeCodeForTokens(code, state);\n    } catch (error: any) {\n      this.handleError(\"callback_error\", error?.message);\n    }\n  }\n\n  async exchangeCodeForTokens(code: string, state: string) {\n    try {\n      const config = this.configManager.get();\n      let tokenData: any;\n      if (config.beUrl) {\n        tokenData = await this.backendClient.exchangeCode(code, state);\n      } else {\n        this.handleError(\"unsuported_grant_type_error\", \"Type de subvention OAuth non encore pris en charge.\");\n        return;\n      }\n      await this.validateTokens(tokenData.data);\n      SessionManager.clear();\n      this.uiManager.setState({ isLoading: false, error: null });\n      config.onSuccess?.(tokenData);\n    } catch (error: any) {\n      this.handleError(\"token_exchange_error\", error?.message);\n    }\n  }\n\n  private async validateTokens(tokenData: TokenResponse) {\n    const config = this.configManager.get();\n    if (tokenData.id_token && config.scope.includes(\"openid\")) {\n      await this.tokenValidator.validateIdToken(tokenData.id_token);\n    }\n    if (config.verifyAccessToken && tokenData.access_token) {\n      await this.tokenValidator.verifyAccessToken(tokenData.access_token);\n    }\n  }\n\n  private handleError(errorCode: string, description?: string) {\n    const errorMessage = ErrorHandler.getErrorMessage(errorCode, description);\n    this.uiManager.setState({ isLoading: false, error: errorMessage });\n    this.configManager.get().onError?.({ error: errorCode, error_description: description });\n  }\n\n  async getUserInfo() {\n    const config = this.configManager.get();\n    if (config.useBackend) {\n      try {\n        return await new BackendClient(config, this.popupManager, this.uiManager).getUserInfoFromBackend();\n      } catch {\n        // fallback\n      }\n    }\n    const userData = SessionManager.getItem(\"user\");\n    return userData ? JSON.parse(userData) : null;\n  }\n\n  async logout() {\n    const config = this.configManager.get();\n    if (config.useBackend) {\n      try { await new BackendClient(config, this.popupManager, this.uiManager).logoutFromBackend(); } catch {}\n    }\n    SessionManager.clear();\n    this.uiManager.setState({ isLoading: false, error: null });\n    this.configManager.get().onLogout?.();\n  }\n\n  destroy() {\n    this.popupManager.close();\n    this.uiManager.destroy();\n    SessionManager.clear();\n  }\n  refresh() {\n    this.uiManager.destroy();\n    (this as any).initialize?.();\n  }\n  getConfig() { return this.configManager.get(); }\n  updateConfig(newConfig: Partial<AuthConfig>) {\n    this.configManager.updateConfig(newConfig);\n    this.urlBuilder = new OAuthUrlBuilder(this.configManager.get());\n    this.tokenValidator = new TokenValidator(this.configManager.get(), this.urlBuilder);\n  }\n}\n\n// UMD-style globals for <script> usage\ndeclare global {\n  interface Window {\n    BjPassAuthWidget?: typeof BjPassAuthWidget;\n    createBjPassWidget?: (config?: Partial<AuthConfig>) => BjPassAuthWidget;\n  }\n}\nif (typeof window !== \"undefined\") {\n  window.BjPassAuthWidget = BjPassAuthWidget;\n  window.createBjPassWidget = (config: Partial<AuthConfig> = {}) => new BjPassAuthWidget(config);\n  document.addEventListener(\"DOMContentLoaded\", () => {\n    const containers = document.querySelectorAll(\"[data-bjpass-widget]\");\n    containers.forEach((container) => {\n      try {\n        const cfgRaw = (container as HTMLElement).dataset.bjpassWidget || \"{}\";\n        const config = JSON.parse(cfgRaw);\n        (config.ui ||= {}).container = `#${(container as HTMLElement).id}`;\n        new BjPassAuthWidget(config);\n      } catch (e) {\n        console.error(\"Failed to initialize BjPass widget:\", e);\n      }\n    });\n  });\n}\n\nexport default BjPassAuthWidget;\n"]}